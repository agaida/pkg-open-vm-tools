--- a/modules/linux/vmhgfs/inode.c
+++ b/modules/linux/vmhgfs/inode.c
@@ -1818,7 +1818,13 @@ HgfsPermission(struct inode *inode,
 
       /* Find a dentry with valid d_count. Refer bug 587789. */
       list_for_each(pos, &inode->i_dentry) {
-         dentry = list_entry(pos, struct dentry, d_alias);
+          dentry = list_entry(pos, struct dentry,
+#if defined(VMW_D_ALIAS_3181) || LINUX_VERSION_CODE >= KERNEL_VERSION(3, 18, 1)
+          d_u.d_alias
+#else
+          d_alias
+#endif
+          );
 #if LINUX_VERSION_CODE < KERNEL_VERSION(2, 6, 38)
          dcount = atomic_read(&dentry->d_count);
 #else
--- a/modules/linux/vmhgfs/Makefile.kernel
+++ b/modules/linux/vmhgfs/Makefile.kernel
@@ -33,6 +33,7 @@ EXTRA_CFLAGS += $(call vm_check_build, $
 EXTRA_CFLAGS += $(call vm_check_build, $(AUTOCONF_DIR)/getsb1.c,, -DVMW_GETSB_2618)
 EXTRA_CFLAGS += $(call vm_check_build, $(AUTOCONF_DIR)/statfs1.c,, -DVMW_STATFS_2618)
 EXTRA_CFLAGS += $(call vm_check_build, $(AUTOCONF_DIR)/inode1.c,, -DVMW_INODE_2618)
+EXTRA_CFLAGS += $(call vm_check_build, $(AUTOCONF_DIR)/d_alias.c,, -DVMW_D_ALIAS_3181)
 
 MODPOST_VMCI_SYMVERS := $(wildcard $(MODULEBUILDDIR)/VMwareVMCIModule.symvers)
 
--- /dev/null
+++ b/modules/linux/shared/autoconf/d_alias.c
@@ -0,0 +1,21 @@
+/*********************************************************
+ * Copyright (C) 2015 Ross Smith II. MIT Licensed.
+ *
+ *********************************************************/
+
+#include "compat_version.h"
+#include "compat_autoconf.h"
+
+#include <linux/dcache.h>
+
+/*
+ * After 3.18.1, the dentry d_alias field was moved to struct d_u.
+ *
+ * This test will fail on a kernel with such a patch.
+ */
+void test(void)
+{
+   struct dentry dentry;
+
+   dentry.d_alias.next = NULL;
+}
